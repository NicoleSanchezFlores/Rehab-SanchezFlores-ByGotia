---
title: "NSF_KBG_Written_Full_Report"
format: pdf
authors: Nicole Sanchez Flores, Kimberly By Gotia
---


```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(readr)
library(janitor)
library(tidyverse)
library(nnet)
library(knitr)
library(kableExtra)
library(broom)
library(dplyr)
library(mosaic)
library(car)
library(reshape2)
rehab <-read_csv("help.csv")
rehab <- clean_names(rehab)

rehab <- rehab |> mutate(
    prim_sub_label = factor(
      prim_sub,
      levels = 0:8,
      labels = c(
        "None",
        "Alcohol",
        "Cocaine",
        "Heroin",
        "Barbiturates",
        "Benzos",
        "Marijuana",
        "Methadone",
        "Opiates"
        )
      )
    )

rehab <- rehab |> mutate(
    home_label = factor(
      homeless,
      levels = 0:1,
      labels = c(
        "No",
        "Yes"
        )
      )
    )

rehab <- rehab |> mutate(
    gender_label = factor(
      a1,
      levels = 1:2,
      labels = c(
        "Male",
        "Female"
        )
      )
    )

#?HELPfull
knitr::opts_chunk$set(
echo = FALSE,
message = FALSE,
warning = FALSE
)
```

## **Data Description:**

-   The data that we will be using comes from the Health Evaluation and Linkage to Primary Care (HELP) study which was a clinical trial for adults receiving in-patient care at a detoxification unit. If patients did not have a primary care physician then they were randomized with the goal of linking to primary medical care. This clinical research data was approved by Institutional Review Board of Boston University Medical Center and is housed in the mosaic RStudio package. For our research focus we will be utilizing the explanatory variables a1 (gender represented by 1 = male and 2 = female), age, homeless (related to homeless status with 0 = no and 1 = yes), and ces_d (center for epidemiologic studies depression measure 0-60). Our chosen variables will help us determine the potential correlation between these factors and the chosen first drug of choice (prim_sub) for an individual in the detoxification unit.

## **Question to Research:**

-   Do age, gender, depression score, and homelessness predict primary substance type?

-   Exposures: age, a1 (gender represented by 1 = male and 2 = female), homeless (related to homeless status with 0 = no and 1 = yes), and ces_d (center for epidemiologic studies depression measure 0-60)

-   Outcomes: The first substance an individual at the detoxification center has taken (prim_sub).

## **Descriptions of variables:**

-   Depression levels (ces_d)

    -   Depression levels in patients in the detoxification center are measured using the Center for Epidemiological Studies depression measure which ranges from 0-60. Patients with higher scores are deemed to have more depressive symptoms.

-   Primary substance (prim_sub)

    -   The primary substance in this data set refers to the first drug of choice for the patient in the detoxification center. The drugs are categorized by levels with 0 = none, 1 = alcohol, 2 = cocaine, 3 = heroin, 4 = barbiturates, 5 = benzos, 6 = marijuana, 7 = methadone, and 8 = opiates.

## **References Summaries:**

1.  [Understanding drug use patterns among the homeless population: A systematic review of quantitative studies](https://www.sciencedirect.com/science/article/pii/S2667118223000107)

    -   Summary: Researchers conducted a systematic review of quantitative studies from 2007 and 2020 to assess the trends associated with substance abuse among the global adult homeless population. They found that alcohol was a highly popular primary drug abuse substance, but overtime there was an emergence in psychoactive substance use as well. Substance abuse was also found to be more common among men due to mental health and trauma stressors.

2.  [Differences in Drug Use among Persons Experiencing Homelessness According to Gender and Nationality](https://www.mdpi.com/2156748)

    -   Summary: This paper focuses on a cross sectional study observing whether there is a statistical difference in drug consumption between homeless men and women in Spanish shelters. They also assess whether there is higher drug usage present among homeless Spanish nationals or immigrants. After conducting the study they found that there was not a statistically significant difference between men and women in their observed population in terms of their drug use. However, they found that the reason behind initial drug use did differ. Women tended to initially use drugs due to partner influence or lack of family affectivity while men initiated drug use because of personality or social factors. We found the difference in initial drug use between men and women to be very interesting especially as we examine whether factors like depression score influence an individual's primary substance in the HELP data.

    -   Additionally, their investigation into whether or not there was a difference in drug risk among homeless Spanish nationals and immigrants found that Spanish nationals were statistically at a higher tendency of drug use compared to immigrants. This section of the research paper seemed compelling for future investigation of whether primary substance differs among homeless populations across the U.S depending on their geographic location. The HELP data does not account for geographic information at this time so for now this is more of a future expansion of our research.

3.  [Homelessness and Gender: Differences in Characteristics and Comorbidity of Substance Use Disorders at Admission to Services](https://www.researchgate.net/publication/366312084_Homelessness_and_Gender_Differences_in_Characteristics_and_Comorbidity_of_Substance_Use_Disorders_at_Admission_to_Services)

    1.  Summary: Study focuses on examining the associations between homelessness, gender, the severity of substance use, and the presence of mental health comorbidity among individuals entering treatment for SUD. After conducting a logistic regression on the 2017 Treatment Episodes dataset they found that individuals experiencing homelessness that admit into services have a higher usage rate of cocaine and meth, have higher frequency of use, and have higher rates of mental health comorbidity. Among their population they also found that women experiencing homelessness were highly associated with having mental health comorbidities. This research study helped in answering a question that bubbled up from our reading of, "Differences in Drug Use among Persons Experiencing Homelessness According to Gender and Nationality" where they found different influential factors impact initial drug use between men and women. We believe that mental health could be a factor that influences primary substance use so finding a paper that observed higher mental health comorbidities among homeless women that use substances is helpful to our research.

## **Exploration of Data:**

**Depression levels (ces_d) general distribution count:**

```{r}
ggplot(rehab, aes(x = ces_d)) + 
  geom_bar() + 
  labs(title = "CES Score Distribution", x = "Score", y = "Total Count") + 
  theme_minimal()
summary(rehab$ces_d)
```

-   Findings: The CES depression scores tend to peak towards the 30-40 score range. This indicates high frequency of mid-range depression symptoms among the population in the HELP data set. This mid-range score finding is also supported by the summary statistics for CES-D scores which indicate a mean of 32.86.

**Primary substance (prim_sub) general distribution count:**

```{r}
ggplot(rehab, aes(x = factor(prim_sub_label))) + 
  geom_bar() + 
  labs(title = "Primary Substance Distribution", x = "Primary Substance", y = "Total Count") + 
  theme_minimal()

summary(rehab$prim_sub)
rehab |>
  group_by(prim_sub) |>
  count()
```

-   Findings: The primary substance with high usage rates among the HELP population is alcohol with the lowest being marijuana. Further information on the exact distribution counts can be found in the summary count of each primary substance group with alcohol having 185 users and marijuana only having 1. It should also be noted that responses to "None", "Barbiturates", "Benzos", "Methadone", and "Opiates" were left off because no patients in the detoxification center responded to those options as their primary substance.

**Depression Score in association with Primary Substance:**

```{r}
ggplot(rehab, aes(x = factor(prim_sub_label), y = ces_d, fill = factor(prim_sub_label))) + 
  geom_boxplot() + 
  labs(title = "Depression Score Grouped by Primary Substance", 
       x = "Primary Substance", 
       y = "CES-D Score") + 
  theme_minimal() + 
  theme(legend.position = "none")
```

-   Findings: After grouping depression score by the different primary substances used by the detoxification patients we found that alcohol tended to have a higher mean depression score (\>35) compared to cocaine and heroine. We also saw that in terms of variance cocaine had a wider range of variance extending to the highest score of 60 indicating a high instance of depression symptoms.

**Depression Score in association with Gender:**

```{r}
ggplot(rehab, aes(x = factor(gender_label), y = ces_d, fill = factor(gender_label))) + 
  geom_boxplot() + 
  labs(title = "Depression Score Grouped by Gender", 
       x = "Gender", 
       y = "CES-D Score") + 
  theme_minimal() + 
  theme(legend.position = "none")
```

-   Findings: When evaluating the depression levels of men versus women in the detoxification center we found that women had a higher depression scores overall. Women had a mean score of \>35 compared to men who scored \~30.

**Homelessness in association with Gender:**

```{r}
ggplot(rehab, aes(x = factor(gender_label), fill = factor(home_label))) + 
  geom_bar(position = "dodge") + 
  labs(title = "Homlessness Distribution Grouped by Gender", 
       x = "Gender", 
       y = "Total Count",
       fill = "Homeless") + 
  theme_minimal() 
```

-   Findings: From this bar plot we can see that for both categories of homelessness men tend to be more represented overall in the HELP data set. However, within the male population there is a close tie between those that are homeless and those that are not. For women this is not the case. Women who are not homeless are at a higher proportion than those that are in the detoxification center.

**Depression Score and Homelessness grouped by Primary Substance:**

```{r}
ggplot(rehab, aes(x = ces_d, color = factor(home_label))) + 
  geom_density() + 
  facet_wrap(~ prim_sub_label) + 
  labs(title = "Depression Score Grouped by Homelessness Across Primary Substances", 
       x = "CES-D Score",
       color = "Homeless"
  ) + 
  theme_minimal()
```

-   Findings: This density chart shows the interaction between homelessness and depression score across different primary substances. From the plot we found an interesting relationship among the heroin drug use group. Detoxification patients who use heroin and are homeless tend to have a higher population representation in scoring a mid-high range depression score (30-40). Meanwhile, those that used heroin and were not homeless were more spread across 20-60.

##Introduction


The data that will be used in this analysis comes from the Health Evaluation and Linkage to Primary Care (HELP) study which was a clinical trial for adults receiving in-patient care at a detoxification unit. If patients did not have a primary care physician then they were randomized with the goal of linking to primary medical care. This clinical research data was approved by Institutional Review Board of Boston University Medical Center and is housed in the mosaic RStudio package. For our research focus we will be utilizing the explanatory variables a1 (gender represented by 1 = male and 2 = female), age, homeless (related to homeless status with 0 = no and 1 = yes), and ces_d (center for epidemiologic studies depression measure 0-60). Our chosen variables will help us determine the potential correlation between these factors and the chosen first drug of choice (prim_sub) for an individual in the detoxification unit. Note that age and ces-d scores were treated as continuous variables while gender and homelessness were treated as categorical variables.

```{r}

rehab <-read_csv("help.csv")
rehab <- clean_names(rehab)

rehab <- rehab |> mutate(
    prim_sub_label = factor(
      prim_sub,
      levels = 0:8,
      labels = c(
        "None",
        "Alcohol",
        "Cocaine",
        "Heroin",
        "Barbiturates",
        "Benzos",
        "Marijuana",
        "Methadone",
        "Opiates"
        )
      )
    )

rehab <- rehab |> mutate(
    home_label = factor(
      homeless,
      levels = 0:1,
      labels = c(
        "No",
        "Yes"
        )
      )
    )

rehab <- rehab |> mutate(
    gender_label = factor(
      a1,
      levels = 1:2,
      labels = c(
        "Male",
        "Female"
        )
      )
    )


#?HELPfull
```

## Methodological Extension: Multinominal Logistic Regression

After conducting our exploratory analysis we found that alcohol was the most frequently reported primary substance followed by cocaine and heroin. The other substance response options of none, barbituates, benzos, methadone, and opiates were not reported. Marijuana was also only reported once among the detoxification center population. Due to this sparsity the analysis was restricted to individuals that reported alcohol, cocaine, and heroin as their primary substance. Given the non-ordinal and multi-category nature of the primary substance outcome, a multinominal logistic regression model was therefore selected for our analysis (Bilder, 2015). Additionally, if binary logistic regression had been used in this instance it would have caused all substances to be collapsed into a single category which would prevent a deeper understanding of the substance-specific relationships between the explanatory variables.

In a multinominal logistic regression model, a base-line category must be assigned to compare the association between age, gender, ces-d depression score, and homelessness status with choice of primary substance use. Our model utilizes alcohol as the base-line reference category due to its high response prevalence (n = 185) among individuals in the detoxification center compared to cocaine (n = 156) and heroin (n = 128).

To account for only alcohol, cocaine, and heroin in the regression the HELP data was cleaned by dropping all unnecessary category outcomes from the primary substance variable:

```{r}
rehab$prim_sub_label <- droplevels(rehab$prim_sub_label)

filtered_rehab <- rehab |>
  group_by(prim_sub_label) |>
  filter(n()>1) |>
  ungroup() |>
  droplevels()

levels(filtered_rehab$prim_sub_label)
table(filtered_rehab$prim_sub_label)
```

The final cleaned dataset now only includes individuals with the primary substances of alcohol (n = 185), cocaine (n = 156), and heroin (n = 128), for a total sample size of N = 469.

Next, the multinominal logistic regression model can be set up to examine the association between age, gender, homelessness status, and ces-d depression score with primary substance while using alcohol as the reference. Let $Y_i$ denote the primary substance for detoxification patient $i$. Since alcohol is being treated as the reference category each remaining substance $j \in$ {cocaine, heroin} will be modeled as: $$log(\frac{P(Y_i = j)}{P(Y_i = alcohol)}) = \beta_{0j} + \beta_{1j}(age_i) + \beta_{2j}(gender_i) + \beta_{3j}(homeless_i) + \beta_{4j}(ces-d_i)$$ This model creates an odds ratio comparison between alcohol and cocaine or heroin as it relates to the explanatory variables to test associations. 

To conduct multinominal logistic regression the `multinom()` function was used from the `nnet` package (Bruin, 2011). 

```{r}
mod.fit <- multinom(formula = prim_sub_label ~ a1 + age + homeless + ces_d, data = filtered_rehab)
summary(mod.fit)

```

The resulting fitted log-odds equations were: 
Cocaine vs Alcohol
$$log(\frac{\hat{\pi}_{cocaine}}{\hat{\pi}_{alcohol}}) = 2.967828 + 0.5151615(gender) - 0.06541560(age) - 0.6770603(homeless) -  0.03327985(ces-d)$$
Heroin vs Alcohol
$$log(\frac{\hat{\pi}_{heroin}}{\hat{\pi}_{alcohol}}) = 2.548504 + 0.2613997(gender) - 0.08280548(age) - 0.7872547(homeless) +  0.00319592(ces-d)$$
These resulting coefficients are the changes in the log odds of choosing cocaine or heroin versus alcohol while holding all explanatory variables constant. The negative age coefficients in both models indicate that for each additional year there is an associated lower log odds of choosing cocaine versus alcohol and heroin versus alcohol. Homelessness shows a similar relationship with a "yes" response to being homeless is associated with lower log odds of cocaine and heroin use versus alcohol. However, CES-D is only negative for cocaine and not heroin indicating that depressive symptom scores are more strongly associated with decreased odds of cocaine use.

An ANOVA Type II test was then used to assess whether each explanatory variable is associated with each primary substance.  

```{r}
Anova(mod.fit)
```

From the resulting deviance table it can be noted that age ($LR_{\chi^{2}}$ = 33.112, $p = 6.453e-08$), homelessness ($LR_{\chi^{2}}$ = 13.270, $p = 0.0013139$), and CES-D ($LR_{\chi^{2}}$ = 17.450, $p = 0.0001625$) are significantly associated with primary substance choice. However, gender was not statistically significant ($LR_{\chi^{2}}$ = 3.437, $p = 0.1793288$). This suggests that even if there is a difference in gender distribution among each primary substance of choice there is not enough evidence to conclude that this difference is significant for this research population. 

## Results 
To further assess the probability of choosing cocaine and heroin versus alcohol relative risk ratios were calculated.  

```{r}

odds_model <- tidy(mod.fit, conf.int = TRUE, exponentiate = TRUE)

odds_model <- odds_model |>
  mutate(
    term = case_when(
      term == "(Intercept)" ~ "Intercept",
      term == "a1" ~ "Gender",
      term == "age" ~ "Age",
      term == "homeless" ~ "Homeless (Y/N)",
      term == "ces_d" ~ "CES-D score",
      TRUE ~ term 
    )
  )

kable(
  odds_model,
  digits = 3,
  booktabs = TRUE, 
  caption = "Odds ratios and 95 percent CI intervals for multinominal logisitc regression (alcohol as reference)."
) |> kable_styling(full_width = FALSE)

```

From the table, age showed a strong association for both cocaine and heroin relative to alcohol. For every additional year of age there was an associated  6.3\% decrease decrease in relative risk of cocaine versus alcohol and a 7.9\% decrease in relative risk of heroin versus alcohol while holding gender, homelessness, and CES-D constant. (Write more)

Predicted probabilities were then conducted to observe the absolute likelihood of choosing any of the primary substance outcomes (Bilder, 2015). 
```{r}
pi.hat <- predict(object = mod.fit, newdata = filtered_rehab, type = "probs")
head(pi.hat)
```

For the first six individuals their predicated probabilities ranged from 0.207 to 0.51 for alcohol, 0.23 to 0.58 for cocaine, and 0.13 to 0.45 for heroin. These probability ranges indicate that the multinominal model does not predict the same probability of choosing a certain primary substance for everyone. Some have a higher predicted probability of choosing cocaine while for others it could be cocaine or heroin. This further supports that changes in a person's characteristics (age, homelessness, and CES-D score) can influence their probability of choosing a certain substance. 



## Predicted Probabilities

```{r}
pp_age <- predict(mod.fit, newdata = newdat_age, type = "probs")
# now we can convert log-odds into probabilities that sum to ,so we model-estimated probabilities of each substance choice.
pp_df_age <- cbind(newdat_age, pp_age)
# no we just combining into our data set pp_df <- cbind(newdat_age, pp)

pp_long_age <- melt(
  pp_df_age,
  id.vars = "age",
  measure.vars = c("Alcohol", "Cocaine", "Heroin"),
  variable.name = "Substance",
  value.name = "Probability"
)

ggplot(pp_long_age,
       aes(x = age, y = Probability, color = Substance)) +
  geom_line(linewidth = 1) +
  labs(
    title = "Predicted Probability of Primary Substance by Age",
    x = "Age",
    y = "Predicted Probability"
  ) +
  theme_minimal() +
  theme(
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5)
  )
```
*- Findings*

Figure (?) displays model-predicted probabilities of primary substance choice across age. When holding depression, gender, and homelessness constant, older individuals are substantially more likely to report alcohol as their primary substance.Younger individuals are more likely to report cocaine as their primary substance, whereas cocaine use declines with increasing age.Heroin use as a primary substance is concentrated among younger individuals and becomes increasingly unlikely at older ages.
(Add some kind of visualization)


# **Discussion**

The focus of this project was to investigate if  age, gender, depression score, and homelessness predict primary substance type. From our multinominal logistic regresion we found significance in age, gender and cs_d, where 
age showed a strong association for both cocaine and heroin relative to alcohol.
For every additional year of age there was an associated 6.3% decrease decrease in relative risk
of cocaine versus alcohol and a 7.9% decrease in relative risk of heroin versus alcohol while
holding gender, homelessness, and CES-D constant. 
With predicted probabilities we found that As depressive symptom severity increases, alcohol becomes increasingly more likely to be the primary substance relative to cocaine and heroin, with cocaine use declining most sharply.

- graph shows the predicted probability of each substance but with depression increasing, while age gender and homeless is constant (figure 1)
(figure two shows) Figure (?) displays model-predicted probabilities of primary substance choice across age. When holding depression, gender, and homelessness constant, older individuals are substantially more likely to report alcohol as their primary substance.Younger individuals are more likely to report cocaine as their primary substance, whereas cocaine use declines with increasing age.Heroin use as a primary substance is concentrated among younger individuals and becomes increasingly unlikely at older ages.









